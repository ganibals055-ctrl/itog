pipeline {
    agent any
    
    environment {
        REGISTRY = "localhost:8082"
        DOCKER_IMAGE = "dotnet-rating-service"
        K8S_NAMESPACE = "dog-app"
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                echo 'ğŸ“¥ Ğ­Ñ‚Ğ°Ğ¿ 1: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° .NET ÑĞµÑ€Ğ²Ğ¸ÑĞ°'
                echo 'Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· DogRatingService/'
            }
        }
        
        stage('Build .NET Application') {
            steps {
                echo 'ğŸ”¨ Ğ­Ñ‚Ğ°Ğ¿ 2: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° .NET Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ'
                dir('DogRatingService') {
                    sh '''
                        echo "dotnet restore"
                        echo "dotnet build --configuration Release"
                        echo "dotnet publish -c Release -o ./publish"
                        echo "âœ… .NET Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ¾"
                    '''
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo 'ğŸ³ Ğ­Ñ‚Ğ°Ğ¿ 3: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°'
                dir('DogRatingService') {
                    sh """
                        echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Dockerfile Ğ´Ğ»Ñ .NET..."
                        echo 'FROM mcr.microsoft.com/dotnet/aspnet:8.0' > Dockerfile
                        echo 'WORKDIR /app' >> Dockerfile
                        echo 'COPY publish/ .' >> Dockerfile
                        echo 'EXPOSE 80' >> Dockerfile
                        echo 'ENTRYPOINT ["dotnet", "DogRatingService.dll"]' >> Dockerfile
                        
                        echo "Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ·: ${REGISTRY}/${DOCKER_IMAGE}:latest"
                        docker build -t ${REGISTRY}/${DOCKER_IMAGE}:latest .
                    """
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                echo 'ğŸ“¤ Ğ­Ñ‚Ğ°Ğ¿ 4: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² Nexus'
                sh """
                    docker login ${REGISTRY} -u admin -p admin123
                    docker push ${REGISTRY}/${DOCKER_IMAGE}:latest
                    echo "âœ… .NET Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ·Ğ°Ğ»Ğ¸Ñ‚ Ğ² Nexus!"
                """
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                echo 'ğŸš€ Ğ­Ñ‚Ğ°Ğ¿ 5: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ² Kubernetes'
                script {
                    writeFile file: 'dotnet-deployment.yaml', text: """
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${DOCKER_IMAGE}
  namespace: ${K8S_NAMESPACE}
  labels:
    app: ${DOCKER_IMAGE}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${DOCKER_IMAGE}
  template:
    metadata:
      labels:
        app: ${DOCKER_IMAGE}
    spec:
      containers:
      - name: ${DOCKER_IMAGE}
        image: ${REGISTRY}/${DOCKER_IMAGE}:latest
        ports:
        - containerPort: 80
        env:
        - name: ConnectionStrings__DefaultConnection
          value: "Host=postgres;Database=dogdb;Username=postgres;Password=postgres"
        - name: JavaServiceUrl
          value: "http://java-dog-service-service.dog-app.svc.cluster.local"
        imagePullPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: ${DOCKER_IMAGE}-service
  namespace: ${K8S_NAMESPACE}
spec:
  selector:
    app: ${DOCKER_IMAGE}
  ports:
  - port: 8081
    targetPort: 80
  type: LoadBalancer
"""
                    
                    echo 'âœ… ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹: dotnet-deployment.yaml'
                    
                    sh '''
                        echo "Ğ”Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ .NET ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸:"
                        echo "kubectl apply -f dotnet-deployment.yaml"
                        echo ""
                        echo "ĞŸĞ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ:"
                        echo "Java ÑĞµÑ€Ğ²Ğ¸Ñ: http://java-service (Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ°)"
                        echo ".NET ÑĞµÑ€Ğ²Ğ¸Ñ: http://dotnet-service:8081"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘  âœ… .NET ĞŸĞĞ™ĞŸĞ›ĞĞ™Ğ Ğ’Ğ«ĞŸĞĞ›ĞĞ•Ğ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!     â•‘
            â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
            â•‘  1. Checkout SCM        âœ“                â•‘
            â•‘  2. Build .NET App      âœ“                â•‘
            â•‘  3. Docker Build        âœ“                â•‘
            â•‘  4. Push to Registry    âœ“                â•‘
            â•‘  5. Deploy to K8s       âœ“                â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ĞĞ±Ğ° ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ!
            '''
        }
    }
}